<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>September | 2012 | Home of noocyte</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="http://blog.noocyte.net/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="http://blog.noocyte.net/wp-content/themes/twentythirteen/js/html5.js"></script>
	<![endif]-->
	<link rel="alternate" type="application/rss+xml" title="Home of noocyte &raquo; Feed" href="../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Home of noocyte &raquo; Comments Feed" href="../../comments/feed/index.html" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"http:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/blog.noocyte.net\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.2.2"}};
			!function(a,b,c){function d(a){var c=b.createElement("canvas"),d=c.getContext&&c.getContext("2d");return d&&d.fillText?(d.textBaseline="top",d.font="600 32px Arial","flag"===a?(d.fillText(String.fromCharCode(55356,56812,55356,56807),0,0),c.toDataURL().length>3e3):(d.fillText(String.fromCharCode(55357,56835),0,0),0!==d.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='twentythirteen-fonts-css'  href='http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A300%2C400%2C700%2C300italic%2C400italic%2C700italic%7CBitter%3A400%2C700&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../../wp-content/themes/twentythirteen/genericons/genericons.css@ver=3.03.css' type='text/css' media='all' />
<link rel='stylesheet' id='twentythirteen-style-css'  href='../../wp-content/themes/twentythirteen/style.css@ver=2013-07-18.css' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentythirteen-ie-css'  href='http://blog.noocyte.net/wp-content/themes/twentythirteen/css/ie.css?ver=2013-07-18' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery.js@ver=1.11.2'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery-migrate.min.js@ver=1.2.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc.php@rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.2.2" />
<!-- Copy this script into your html file to enable Application Insights -->
<script type="text/javascript">
    window.appInsights={queue:[],applicationInsightsId:null,accountId:null,appUserId:null,configUrl:null,start:function(n){function u(n,t){n[t]=function(){var i=arguments;n.queue.push(function(){n[t].apply(n,i)})}}function f(n){var t=document.createElement("script");return t.type="text/javascript",t.src=n,t.async=!0,t}function r(){i.appendChild(f("//az416426.vo.msecnd.net/scripts/ai.0.js"))}var i,t;this.applicationInsightsId=n;u(this,"logEvent");u(this,"logPageView");i=document.getElementsByTagName("script")[0].parentNode;this.configUrl===null?r():(t=f(this.configUrl),t.onload=r,t.onerror=r,i.appendChild(t));this.start=function(){}}};

    appInsights.start("5e97fe9e-52e7-4eab-8869-5501ea0cdbe9");
    appInsights.logPageView();
</script>	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
	<style type="text/css" id="twentythirteen-header-css">
			.site-header {
			background: url(../../wp-content/themes/twentythirteen/images/headers/circle.png) no-repeat scroll top;
			background-size: 1600px auto;
		}
		@media (max-width: 767px) {
			.site-header {
				background-size: 768px auto;
			}
		}
		@media (max-width: 359px) {
			.site-header {
				background-size: 360px auto;
			}
		}
		</style>
	</head>

<body class="archive date single-author">
	<div id="page" class="hfeed site">
		<header id="masthead" class="site-header" role="banner">
			<a class="home-link" href="../../index.html" title="Home of noocyte" rel="home">
				<h1 class="site-title">Home of noocyte</h1>
				<h2 class="site-description">Ramblings of a mad mind</h2>
			</a>

			<div id="navbar" class="navbar">
				<nav id="site-navigation" class="navigation main-navigation" role="navigation">
					<button class="menu-toggle">Menu</button>
					<a class="screen-reader-text skip-link" href="index.html#content" title="Skip to content">Skip to content</a>
					<div class="nav-menu"><ul><li class="page_item page-item-302"><a href="../../index.html@p=302.html">About</a></li></ul></div>
					<form role="search" method="get" class="search-form" action="../../index.html">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form>				</nav><!-- #site-navigation -->
			</div><!-- #navbar -->
		</header><!-- #masthead -->

		<div id="main" class="site-main">

	<div id="primary" class="content-area">
		<div id="content" class="site-content" role="main">

					<header class="archive-header">
				<h1 class="archive-title">Monthly Archives: September 2012</h1>
			</header><!-- .archive-header -->

										
<article id="post-662" class="post-662 post type-post status-publish format-standard hentry category-work tag-entity-framework tag-orm tag-performance">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="../../index.html@p=662.html" rel="bookmark">ORMs and Performance</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="../../index.html@p=662.html" title="Permalink to ORMs and Performance" rel="bookmark"><time class="entry-date" datetime="2012-09-07T13:01:31+00:00">September 7, 2012</time></a></span><span class="categories-links"><a href="../../category/english/work/index.html" rel="category tag">Geek</a></span><span class="tags-links"><a href="../../tag/entity-framework/index.html" rel="tag">entity framework</a>, <a href="../../tag/orm/index.html" rel="tag">orm</a>, <a href="../../tag/performance/index.html" rel="tag">performance</a></span><span class="author vcard"><a class="url fn n" href="../../author/noocyte/index.html" title="View all posts by noocyte" rel="author">noocyte</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>In one of my projects, actually <a href="http://proactima.no/">Proactimas</a> project, I’m using <a href="http://msdn.microsoft.com/en-us/data/ef.aspx">Entity Framework</a> (EF) on top of <a href="http://www.windowsazure.com/home/features/data-management/">SQL Azure</a> and it works pretty well; data access is relatively fast, dead easy most of the time and the cost (in $) is OK. However I have discovered how sensitive EF is to how you write your queries. It appears to be especially true if you have several one-to-many relationships. </p>
<p>Just a quick introduction to Proactima Compliance; Any user has access to one or more companies, each company consists of one or more units. Units can be things like ‘Head Office’, IT-department, a ship etc. For every unit there can be one or more evaluations and each evaluation is based on a set of rules that the company measure compliance against. An example of a ruleset is the <a href="http://www.npd.no/en/Regulations/Acts/Petroleum-activities-act/">Petroleum Activities Act</a> in Norway. </p>
<p>In <a href="http://www.proactima.no">Proactima</a> Compliance the most frequently accessed page had an action that took about 1000ms to complete. This page allows the user to evaluate a rule and then choose ‘Save and Next’; so there are two actions involved:</p>
<ol>
<li>Save current rule and find next based on previous rules’ sequence
<li>Load next rule and display it to the user</li>
</ol>
<p>The second action completes in 200-400ms, but the first takes from 800-1200 ms to complete. The main reason for the long processing time is what <a href="http://miniprofiler.com/">MiniProfiler</a> calls Duplicate Readers. Basically, because of the way I had written my queries it was executing a reader querying for each rule in a ruleset! It looked like this:</p>
<p><a href="http://blog.noocyte.net/wp-content/uploads/2012/09/Pre_Optimize.png"><img title="Pre_Optimize" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Pre_Optimize" src="http://blog.noocyte.net/wp-content/uploads/2012/09/Pre_Optimize_thumb.png" width="590" height="144"></a></p>
<p>It’s running 103 (!) queries just for that one action, that’s terrible! The actual query looked like this:</p>
<pre class="brush: c-sharp; toolbar: false">var rules = from r in evaluationRule.Evaluation.Rules
                 where r.Rule.Sequence &gt; currentSequence 
                 orderby r.Rule.Sequence 
                 select r;</pre>
<p>The variable ‘evaluationRule’ was already fetched from the database and so I was just navigating to its Evaluation (remember how an evaluation is based on a ruleset which in turn consists of individual rules) and then the ruleset for that evaluation. Then I set up the where clause to make sure we can only get a rule with a sequence higher than the current rule. Finally I do an order by and select, from this I will only choose the first rule thus getting the next rule based on sequence. Possible bug here; sequences could potentially be same, but I’m 100% in control of the sequences so that’s really not an issue.</p>
<p>I won’t show the rendered query from this, it’s a nightmare, but the end result is correct and dead slow… So I had to fix this! I tried to manipulate the query in a try-fail-retry pattern; no success at all! I figured after awhile that I was addressing the issue from the wrong end; I was just thinking of the code. Thinking back on previous issues I’ve had with generated Sql (from other ORMs) I remembered (finally!) an old lesson; start by writing the query manually in the best possible way you can and <em>then</em> try to express that same query using the ORM! So that’s what I did! I fired up <a href="http://www.microsoft.com/en-us/download/details.aspx?id=22985">Sql Server Management Studio Express 2012 Deluxe Gold Plated Edition</a>, or whatever it’s called and thought really hard about what I <strong>really</strong> needed. What I ended up with was this:</p>
<pre class="brush: sql; toolbar: false">DECLARE @currentSequence int = 1;
DECLARE @currentEvaluation int = 1;

select	top 1 er.ID, 
	er.RuleID,
	r.Sequence,
	er.EvaluationID
from	EvaluationRules er,
	Rules r
where	er.RuleID = r.ID
and	er.EvaluationID = @currentEvaluation
and	r.Sequence &gt; @currentSequence
order by r.Sequence;</pre>
<p>Not that hard to write at all. Now all I needed was to convert it to EF code:</p>
<pre class="brush: c-sharp; toolbar: false">var rules =
    (from er in Database.EvaluationRules
        join r in Database.Rules on er.RuleID equals r.ID
        where er.EvaluationID == evaluationId
        &amp;&amp; r.Sequence &gt; currentSequence
        orderby r.Sequence
        select er)
        .Take(1);</pre>
<p>It’s definitely a bit more than my original code based query, but as you can see it looks a whole lot like the manual sql query. And how does MiniProfiler now report on my page:</p>
<p><a href="http://blog.noocyte.net/wp-content/uploads/2012/09/Post_Optimize.png"><img title="Post_Optimize" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="Post_Optimize" src="http://blog.noocyte.net/wp-content/uploads/2012/09/Post_Optimize_thumb.png" width="574" height="136"></a><br /><em>Please ignore the minor differences (controller name); I have done some other refactoring&#8217;s as well as the query.</em></p>
<p>What an amazing change! 900ms to 222ms! And 100+ queries to just 7! That’s performance optimizations the user notices! </p>
<p>But why did it all go so terribly wrong in the first place? I’m not going to over analyze the two queries or discuss how EF generates the Sql; somebody much smarter than me can probably do that (or has!). But what I learned from all this is that my old skills as Sql developer isn’t lost even if I am using an ORM AND the way you express a query can matter a whole lot when it comes to performance! </p>
	</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="../../index.html@p=662.html#respond"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
							
<article id="post-572" class="post-572 post type-post status-publish format-standard hentry category-work tag-values">
	<header class="entry-header">
		
				<h1 class="entry-title">
			<a href="../../index.html@p=572.html" rel="bookmark">On Corporate Values and Developers</a>
		</h1>
		
		<div class="entry-meta">
			<span class="date"><a href="../../index.html@p=572.html" title="Permalink to On Corporate Values and Developers" rel="bookmark"><time class="entry-date" datetime="2012-09-03T12:04:25+00:00">September 3, 2012</time></a></span><span class="categories-links"><a href="../../category/english/work/index.html" rel="category tag">Geek</a></span><span class="tags-links"><a href="../../tag/values/index.html" rel="tag">Values</a></span><span class="author vcard"><a class="url fn n" href="../../author/noocyte/index.html" title="View all posts by noocyte" rel="author">noocyte</a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		<p>I work for a company called <a href="http://www.proactima.no">Proactima AS</a>, we deliver HSE&amp;Q/RISK consultants to our customers. But I have been hired to do some development for them. <a href="http://www.proactima.no">Proactima</a> is a company that runs close to a 100% on knowledge and so our main resource is the consultants working here. As so many other companies Proactima has a set of values defined:</p>
<ul>
<li>Knowledge</li>
<li>Balance</li>
<li>Integrity</li>
</ul>
<p>And so everything we do is evaluated against them;</p>
<ul>
<li>Can we work with this client?</li>
<li>Are we interested in bidding on this job?</li>
<li>Can this consultant handle more load?</li>
<li>etc.</li>
</ul>
<p>in theory most companies operate like this, but very few actually adheres to them. We have turned down job offers because of our integrity, workload is scaled down if a consultant wants to focus more on home than job for a period etc. I myself have had issues at home where work was not my number one priority and then my manager (resource owner really) scaled down my work load accordingly. Our chairman of the board even asked me why I as in the office during that difficult time (more on this later IF I’m up for it). So you see, we live and die by our values. We do not steer the ship by financial numbers alone, but rather on how well we mange to live up to our own values.</p>
<p>At this point you might be wondering why I’m telling you all this? Or perhaps you’re not even reading it… The thing is, the last few weeks I’ve been evaluating myself according to these three seemingly simple values; Knowledge, Balance and Integrity. Not just myself really, but people around me as well. And the things that I do. How well does it all stack up against these values? </p>
<p>First of all I found that I could easily rate most people on the three values and I realized that I had more respect for those that rated high on these values vs. other values. Because, let’s be honest here, Proactima could’ve chosen completely different values! <a href="http://www.statoil.com/en">Statoil</a> has <a href="http://www.statoil.com/en/About/EthicsValues/Pages/default.aspx">chosen</a>: Courageous, Open, Hands-on and Caring. All fine values, but not what Proactima chose and not what I would have chosen. </p>
<p>Furthermore I found that I could rate my work (programming that is) according to the values:</p>
<ul>
<li>Is the code using the best components and the correct algorithms? (Knowledge)</li>
<li>Am I spending too much time on problems that does not warrant it? (Balance)</li>
<li>Will the code be maintainable when somebody else takes over responsibility for it? (Integrity)</li>
</ul>
<p>Are you evaluating yourself and your code according to a set of values? If not; perhaps you should…</p>
	</div><!-- .entry-content -->
	
	<footer class="entry-meta">
					<div class="comments-link">
				<a href="../../index.html@p=572.html#respond"><span class="leave-reply">Leave a comment</span></a>			</div><!-- .comments-link -->
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
			
			
		
		</div><!-- #content -->
	</div><!-- #primary -->


		</div><!-- #main -->
		<footer id="colophon" class="site-footer" role="contentinfo">
				<div id="secondary" class="sidebar-container" role="complementary">
		<div class="widget-area">
			<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="../../index.html">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" title="Search for:" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Recent Posts</h3>		<ul>
					<li>
				<a href="../../index.html@p=1672.html">Contributing to open source, part II</a>
						</li>
					<li>
				<a href="../../index.html@p=1602.html">Ninject and Factory Injection</a>
						</li>
					<li>
				<a href="../../index.html@p=1562.html">Contributing to open source, part I</a>
						</li>
					<li>
				<a href="../../index.html@p=1342.html">Transient Fault Handling Application Block</a>
						</li>
					<li>
				<a href="../../index.html@p=1252.html">Azure Workers</a>
						</li>
				</ul>
		</aside><aside id="recent-comments-2" class="widget widget_recent_comments"><h3 class="widget-title">Recent Comments</h3><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href='../../index.html@p=1672.html' rel='external nofollow' class='url'>Contributing to open source, part II | Home of noocyte</a></span> on <a href="../../index.html@p=1252.html#comment-75">Azure Workers</a></li><li class="recentcomments"><span class="comment-author-link"><a href='../../index.html@p=1672.html' rel='external nofollow' class='url'>Contributing to open source, part II | Home of noocyte</a></span> on <a href="../../index.html@p=1562.html#comment-76">Contributing to open source, part I</a></li><li class="recentcomments"><span class="comment-author-link"><a href='../11/my-first-adventures-in-git/index.html' rel='external nofollow' class='url'>My first adventures in Git | Home of noocyte</a></span> on <a href="../../index.html@p=167.html#comment-52">Double Key Dictionary</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://www.kcrunforlife.com/blog/2011/03/08/tune-in-to-see-Brad-Prestons-blog.aspx' rel='external nofollow' class='url'>new android apps</a></span> on <a href="../../index.html@p=167.html#comment-51">Double Key Dictionary</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://clickherenow' rel='external nofollow' class='url'>Lissa Lloyd</a></span> on <a href="../../index.html@p=167.html#comment-50">Double Key Dictionary</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
	<li><a href='../../2014/03/index.html'>March 2014</a></li>
	<li><a href='../../2014/02/index.html'>February 2014</a></li>
	<li><a href='../../2013/11/index.html'>November 2013</a></li>
	<li><a href='../../2013/01/index.html'>January 2013</a></li>
	<li><a href='../11/index.html'>November 2012</a></li>
	<li><a href='../10/index.html'>October 2012</a></li>
	<li><a href='index.html'>September 2012</a></li>
	<li><a href='../08/index.html'>August 2012</a></li>
	<li><a href='../../2011/11/index.html'>November 2011</a></li>
	<li><a href='../../2011/10/index.html'>October 2011</a></li>
	<li><a href='../../2011/09/index.html'>September 2011</a></li>
	<li><a href='../../2009/10/index.html'>October 2009</a></li>
	<li><a href='../../2009/08/index.html'>August 2009</a></li>
	<li><a href='../../2008/11/index.html'>November 2008</a></li>
	<li><a href='../../2008/10/index.html'>October 2008</a></li>
	<li><a href='../../2008/09/index.html'>September 2008</a></li>
	<li><a href='../../2008/08/index.html'>August 2008</a></li>
	<li><a href='../../2008/07/index.html'>July 2008</a></li>
	<li><a href='../../2008/06/index.html'>June 2008</a></li>
	<li><a href='../../2008/05/index.html'>May 2008</a></li>
	<li><a href='../../2008/04/index.html'>April 2008</a></li>
	<li><a href='../../2008/03/index.html'>March 2008</a></li>
	<li><a href='../../2008/02/index.html'>February 2008</a></li>
	<li><a href='../../2008/01/index.html'>January 2008</a></li>
	<li><a href='../../2007/12/index.html'>December 2007</a></li>
	<li><a href='../../2007/11/index.html'>November 2007</a></li>
	<li><a href='../../2007/10/index.html'>October 2007</a></li>
		</ul>
</aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-3"><a href="../../category/english/work/index.html" >Geek</a>
</li>
	<li class="cat-item cat-item-4"><a href="../../category/english/link/index.html" >Link</a>
</li>
	<li class="cat-item cat-item-6"><a href="../../category/english/personal/index.html" >Personal</a>
</li>
	<li class="cat-item cat-item-7"><a href="../../category/uxrisk/index.html" >uxrisk</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>			<ul>
						<li><a href="../../wp-login.php.html">Log in</a></li>
			<li><a href="../../feed/index.html">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="../../comments/feed/index.html">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
</aside>		</div><!-- .widget-area -->
	</div><!-- #secondary -->

			<div class="site-info">
								<a href="http://wordpress.org/" title="Semantic Personal Publishing Platform">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<script type='text/javascript' src='../../wp-includes/js/masonry.min.js@ver=3.1.2'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery.masonry.min.js@ver=3.1.2'></script>
<script type='text/javascript' src='../../wp-content/themes/twentythirteen/js/functions.js@ver=2014-06-08'></script>
</body>
</html>